---
- name: Copy mysql driver
  copy: src='mysql-connector-java-5.0.8-bin.jar' dest=/usr/share/java mode=755

- name: Copy migrations
  copy: src={{deployment_environment}}-migrations.xml dest=/tmp mode=755

- name: wait for bahmini server to start
  uri: url=http://localhost:8080/openmrs/index.htm return_content=true

- name: Check whether epel is installed already
  command: rpm -q epel-release
  register: rpm_check_epel_release
  ignore_errors: True

- name: Install epel repo
  command:
    rpm -iUvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
  when: rpm_check_epel_release.rc == 1

- name: Install liquibase
  yum: name=liquibase state=latest

- name: Apply migrations
  shell: liquibase --url="jdbc:mysql://localhost/terminologies" --username=root --password=password --changeLogFile=/tmp/{{deployment_environment}}-migrations.xml --classpath=/usr/share/java/mysql-connector-java-5.0.8-bin.jar update
